#!/bin/bash

# ============================================
# GitSync - Secure repo sync via SSH
# ============================================

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

# Load config
CONFIG_FILE="${XDG_CONFIG_HOME:-$HOME/.config}/gitsync/config"

if [ ! -f "$CONFIG_FILE" ]; then
    echo -e "${RED}✗ Config not found: $CONFIG_FILE${NC}"
    echo "Create it with:"
    echo "  mkdir -p ~/.config/gitsync"
    echo "  echo 'SERVER=your.server.com' >> ~/.config/gitsync/config"
    echo "  echo 'PORT=2222' >> ~/.config/gitsync/config"
    echo "  echo 'LOCAL_PATH=\$HOME/Git' >> ~/.config/gitsync/config"
    exit 1
fi

source "$CONFIG_FILE"

# Validate required config
if [ -z "$SERVER" ] || [ -z "$PORT" ] || [ -z "$LOCAL_PATH" ]; then
    echo -e "${RED}✗ Missing config. Required: SERVER, PORT, LOCAL_PATH${NC}"
    exit 1
fi

# SSH command with timeout
SSH_CMD="ssh -p $PORT -o ConnectTimeout=10"

# Ensure local path exists
mkdir -p "$LOCAL_PATH"

run_rsync() {
    local output
    local exit_code
    output=$("$@" 2>&1)
    exit_code=$?
    if [ $exit_code -ne 0 ]; then
        echo -e "${RED}✗ Error (exit code $exit_code):${NC}"
        echo "$output"
        exit $exit_code
    fi
    echo "$output"
    return 0
}

# Parse depth for status command
DEPTH=1
for arg in "$@"; do
    case "$arg" in
        --depth=*) DEPTH="${arg#*=}" ;;
    esac
done

case "$1" in
    down|pull)
        echo -e "${BLUE}Checking server before pull...${NC}"
        file_count=$(rsync -n --stats -e "$SSH_CMD" "gitsync@$SERVER:." 2>/dev/null | grep "Number of files" | head -1 | grep -oE '[0-9,]+' | tr -d ',')
        if [ -z "$file_count" ] || [ "$file_count" -lt 10 ]; then
            echo -e "${RED}✗ Server appears empty or has very few files ($file_count).${NC}"
            echo -e "${RED}  Refusing to pull to avoid deleting your local ~/Git.${NC}"
            echo -e "${YELLOW}  If this is intentional, remove this check or use rsync manually.${NC}"
            exit 1
        fi
        echo -e "${GREEN}✓ Server has $file_count files. Proceeding...${NC}"
        echo -e "${BLUE}Pulling from server...${NC}"
        run_rsync rsync -avz --progress --delete --filter=':- .gitignore' \
            -e "$SSH_CMD" \
            "gitsync@$SERVER:." "$LOCAL_PATH/"
        echo -e "${GREEN}✓ Sync complete${NC}"
        ;;
    up|push)
        echo -e "${BLUE}Pushing to server...${NC}"
        run_rsync rsync -avz --progress --delete --filter=':- .gitignore' \
            -e "$SSH_CMD" \
            "$LOCAL_PATH/" "gitsync@$SERVER:."
        echo -e "${GREEN}✓ Sync complete${NC}"
        ;;
    status)
        echo -e "${BLUE}[DRY-RUN] Comparing local vs server...${NC}"
        output=$(rsync -rin --delete --filter=':- .gitignore' \
            -e "$SSH_CMD" \
            "$LOCAL_PATH/" "gitsync@$SERVER:." 2>&1)
        exit_code=$?
        # Code 23 = partial transfer (some files skipped) - treat as warning
        if [ $exit_code -ne 0 ] && [ $exit_code -ne 23 ]; then
            echo -e "${RED}✗ Connection failed (exit code $exit_code):${NC}"
            echo "$output"
            exit $exit_code
        fi
        echo -e "${GREEN}✓ Connected to $SERVER:$PORT${NC}"

        # Parse rsync itemize output and group by directory
        declare -A added modified deleted
        total_added=0
        total_modified=0
        total_deleted=0

        while IFS= read -r line; do
            [[ -z "$line" ]] && continue
            # rsync -i format: YXcstpoguax path
            # Y: update type (< sent, > received, c local change, h hard link, . no update, * message)
            # X: file type (f file, d directory, L symlink, etc)
            flags="${line:0:11}"
            path="${line:12}"

            # Skip empty paths and root
            [[ -z "$path" || "$path" == "./" ]] && continue

            # Determine change type
            change_type=""
            if [[ "$line" == *deleting* ]]; then
                change_type="deleted"
            elif [[ "${flags:0:1}" == ">" || "${flags:0:1}" == "c" ]]; then
                # Check if it's a new file (all flags set) or modification
                if [[ "${flags:2:1}" == "+" ]]; then
                    change_type="added"
                else
                    change_type="modified"
                fi
            elif [[ "${flags:0:1}" == "<" ]]; then
                change_type="modified"
            fi

            [[ -z "$change_type" ]] && continue

            # Skip directories themselves, only count files
            [[ "$path" == */ ]] && continue

            # Get directory at specified depth
            dir=$(echo "$path" | cut -d'/' -f1-"$DEPTH")
            # If the path has more components than depth, add trailing /
            if [[ $(echo "$path" | tr -cd '/' | wc -c) -ge $DEPTH ]]; then
                dir="$dir/"
            fi

            # Count by type and directory
            case "$change_type" in
                added)
                    ((added["$dir"]++))
                    ((total_added++))
                    ;;
                modified)
                    ((modified["$dir"]++))
                    ((total_modified++))
                    ;;
                deleted)
                    ((deleted["$dir"]++))
                    ((total_deleted++))
                    ;;
            esac
        done <<< "$output"

        total=$((total_added + total_modified + total_deleted))

        if [ $total -eq 0 ]; then
            echo -e "${GREEN}✓ No differences found.${NC}"
        else
            echo ""
            # Collect all unique directories
            declare -A all_dirs
            for dir in "${!added[@]}"; do all_dirs["$dir"]=1; done
            for dir in "${!modified[@]}"; do all_dirs["$dir"]=1; done
            for dir in "${!deleted[@]}"; do all_dirs["$dir"]=1; done

            # Print grouped by directory
            for dir in $(echo "${!all_dirs[@]}" | tr ' ' '\n' | sort); do
                a=${added["$dir"]:-0}
                m=${modified["$dir"]:-0}
                d=${deleted["$dir"]:-0}

                # Build change indicator
                indicator=""
                [[ $a -gt 0 ]] && indicator="${indicator}${GREEN}+$a${NC} "
                [[ $m -gt 0 ]] && indicator="${indicator}${YELLOW}~$m${NC} "
                [[ $d -gt 0 ]] && indicator="${indicator}${RED}-$d${NC} "

                printf "  %-40s %b\n" "$dir" "$indicator"
            done

            echo ""
            echo -e "Summary: ${GREEN}+$total_added${NC} ${YELLOW}~$total_modified${NC} ${RED}-$total_deleted${NC} ($total files)"
            echo -e "${YELLOW}Run 'gitsync up' to push these changes${NC}"
        fi

        if [ $exit_code -eq 23 ]; then
            echo -e "${YELLOW}⚠ Warning: some files were skipped:${NC}"
            echo "$output" | grep -E '^rsync:|permission denied|vanished|failed' | head -10
        fi
        ;;
    *)
        echo "Usage: gitsync [down|up|status] [options]"
        echo ""
        echo -e "  ${GREEN}down${NC}    Pull from server to local"
        echo -e "  ${GREEN}up${NC}      Push from local to server"
        echo -e "  ${GREEN}status${NC}  Show differences (dry-run)"
        echo ""
        echo "Options:"
        echo "  --depth=N   Directory depth for status grouping (default: 1)"
        exit 1
        ;;
esac
